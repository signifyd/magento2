<?xml version="1.0" encoding="UTF-8"?>

<tests xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:noNamespaceSchemaLocation="urn:magento:mftf:Test/etc/testSchema.xsd">
    <test name="SignifydRejectPostAuthCreditMemoTest" extends="SignifydSuccessPostAuthCaseTest">
        <annotations>
            <features value="Sales"/>
            <stories value="Post Auth do refund negative action"/>
            <title value="Post Auth do refund negative action"/>
            <description value="Validate post auth do refund negative action"/>
            <severity value="CRITICAL"/>
            <group value="checkout"/>
        </annotations>
        <before>
            <createData entity="Signifyd_Customer_Refuse" stepKey="createCustomer"/>

            <!-- Set Signifyd negative action-->
            <magentoCLI command="config:set {{GuaranteeNegativeAction.path}} {{GuaranteeNegativeAction.refund}}" stepKey="setNegativeAction"/>
        </before>

        <!--As Check/Money is an offline payment method, it is necessary to create the invoice for Signifyd to create the Credit memo-->
        <actionGroup ref="AdminOrderSignifydPageActionGroup" stepKey="unholdOrder" before="seeCaseCreated"/>
        <actionGroup ref="StartCreateInvoiceFromOrderPageActionGroup" stepKey="createInvoice" before="seeCaseCreated"/>
        <actionGroup ref="SubmitInvoiceActionGroup" stepKey="submitInvoice" before="seeCaseCreated"/>
        <actionGroup ref="AdminHoldOrderSignifydPageActionGroup" stepKey="holdOrder" before="seeCaseCreated"/>

        <!-- Cron run -->
        <magentoCLI command="cron:run" stepKey="cronRun" before="seeCaseCreated"/>
        <wait stepKey="waitCronRun" time="15" before="seeCaseCreated"/>

        <!--Refresh page to validate cron processing -->
        <reloadPage stepKey="reloadAdminOrderPage" before="seeCaseCreated"/>

        <!-- Assert that the case was reject -->
        <see selector="{{AdminSignifydSection.signifydDecision}}" userInput="REJECT" stepKey="seeCaseCreated"/>
        <!-- Assert that the order is on hold -->
        <see selector="{{AdminSignifydSection.magentoOrderStatus}}" userInput="Processing" stepKey="seeOrderStatus"/>
    </test>
</tests>