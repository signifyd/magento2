From 68540ede45118769f48f6300a39b6b9fde6d9d29 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?=C3=89bano=20Lopes?= <ebano@onbi.com.br>
Date: Fri, 30 Aug 2024 22:13:39 +0000
Subject: [PATCH] MAG-933: Accept.js data error on Checkout Page

---
 .../ParadoxLabsAuthorizenetcim/BinMapper.php  | 33 +++++++++++++++++++
 Observer/PreAuth.php                          | 24 +++++++++-----
 etc/config.xml                                |  4 +++
 3 files changed, 53 insertions(+), 8 deletions(-)
 create mode 100644 Model/Payment/ParadoxLabsAuthorizenetcim/BinMapper.php

diff --git a/vendor/signifyd/module-connect/Model/Payment/ParadoxLabsAuthorizenetcim/BinMapper.php b/vendor/signifyd/module-connect/Model/Payment/ParadoxLabsAuthorizenetcim/BinMapper.php
new file mode 100644
index 0000000..504582c
--- /dev/null
+++ b/vendor/signifyd/module-connect/Model/Payment/ParadoxLabsAuthorizenetcim/BinMapper.php
@@ -0,0 +1,33 @@
+<?php
+
+namespace Signifyd\Connect\Model\Payment\ParadoxLabsAuthorizenetcim;
+
+use Signifyd\Connect\Model\Payment\Base\BinMapper as Base_BinMapper;
+
+class BinMapper extends Base_BinMapper
+{
+    /**
+     * Gets bin digits on Magento's payment additional information
+     *
+     * @param \Magento\Sales\Model\Order $order
+     * @return null|string
+     */
+    public function getPaymentData(\Magento\Sales\Model\Order $order)
+    {
+        $additionalInfo = $order->getPayment()->getAdditionalInformation();
+
+        $bin = null;
+        if (isset($additionalInfo['card_bin'])) {
+            $bin = $additionalInfo['card_bin'];
+        }
+
+        $message = 'Bin found on payment mapper: ' . (empty($bin) ? 'false' : 'true');
+        $this->logger->debug($message, ['entity' => $order]);
+
+        if (empty($bin)) {
+            $bin = parent::getPaymentData($order);
+        }
+
+        return $bin;
+    }
+}
diff --git a/vendor/signifyd/module-connect/Observer/PreAuth.php b/vendor/signifyd/module-connect/Observer/PreAuth.php
index 6f404db..aaf0dfc 100644
--- a/vendor/signifyd/module-connect/Observer/PreAuth.php
+++ b/vendor/signifyd/module-connect/Observer/PreAuth.php
@@ -302,7 +302,7 @@ class PreAuth implements ObserverInterface
             }
 
             $this->logger->info("Creating case for quote {$quote->getId()}", ['entity' => $quote]);
-            $this->addSignifydDataToPayment($quote, $checkoutPaymentDetails);
+            $this->addSignifydDataToPayment($quote, $checkoutPaymentDetails, $paymentMethod);
             $checkoutOrder = $this->checkoutOrderFactory->create();
             $caseFromQuote = $checkoutOrder($quote, $checkoutPaymentDetails, $paymentMethod);
             $caseResponse = $this->client->postCaseFromQuoteToSignifyd($caseFromQuote, $quote);
@@ -393,11 +393,14 @@ class PreAuth implements ObserverInterface
     }
 
     /**
-     * @param \Magento\Quote\Model\Quote $quote
-     * @param array $checkoutPaymentDetails
+     * Add data to payment
+     *
+     * @param $quote
+     * @param $checkoutPaymentDetails
+     * @param $paymentMethod
      * @return void
      */
-    public function addSignifydDataToPayment($quote, $checkoutPaymentDetails)
+    public function addSignifydDataToPayment($quote, $checkoutPaymentDetails, $paymentMethod)
     {
         if (empty($checkoutPaymentDetails)) {
             return;
@@ -405,10 +408,11 @@ class PreAuth implements ObserverInterface
 
         $ccNumber = $quote->getPayment()->getData('cc_number');
 
-        if (!isset($ccNumber) &&
-            isset($checkoutPaymentDetails['cardBin']) &&
-            isset($checkoutPaymentDetails['cardLast4'])) {
-
+        if (!isset($ccNumber)
+            && isset($checkoutPaymentDetails['cardBin'])
+            && isset($checkoutPaymentDetails['cardLast4'])
+            && $paymentMethod !== 'authnetcim'
+        ) {
             $quote->getPayment()->setData(
                 'cc_number',
                 ($checkoutPaymentDetails['cardBin'] ?? '000000') .
@@ -417,6 +421,10 @@ class PreAuth implements ObserverInterface
             );
         }
 
+        if (isset($checkoutPaymentDetails['cardBin'])) {
+            $quote->getPayment()->setAdditionalInformation('card_bin', $checkoutPaymentDetails['cardBin']);
+        }
+
         if (isset($checkoutPaymentDetails['holderName'])) {
             $quote->getPayment()->setCcOwner($checkoutPaymentDetails['holderName']);
         }
diff --git a/vendor/signifyd/module-connect/etc/config.xml b/vendor/signifyd/module-connect/etc/config.xml
index 2736bae..b121d97 100644
--- a/vendor/signifyd/module-connect/etc/config.xml
+++ b/vendor/signifyd/module-connect/etc/config.xml
@@ -80,6 +80,10 @@
                     <signifyd_bin_adapter>Signifyd\Connect\Model\Payment\RootwaysAuthorizecimOption\BinMapper</signifyd_bin_adapter>
                 </rootways_authorizecim_option>
 
+                <authnetcim>
+                    <signifyd_bin_adapter>Signifyd\Connect\Model\Payment\ParadoxLabsAuthorizenetcim\BinMapper</signifyd_bin_adapter>
+                </authnetcim>
+
                 <braintree>
                     <signifyd_avs_ems_adapter>Signifyd\Connect\Model\Payment\Braintree\AvsEmsCodeMapper</signifyd_avs_ems_adapter>
                     <signifyd_cvv_ems_adapter>Signifyd\Connect\Model\Payment\Braintree\CvvEmsCodeMapper</signifyd_cvv_ems_adapter>
-- 
2.17.1

